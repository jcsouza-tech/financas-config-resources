# Configuração Completa do Extrato API para Desenvolvimento
# Todas as configurações em um único arquivo

spring:
  application:
    name: extrato-api
  
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 10MB
      file-size-threshold: 2MB
      resolve-lazily: false

  # Configuração de CORS
  web:
    cors:
      allowed-origins: 
        - "http://localhost:3000"
        - "http://localhost:4000"
        - "http://127.0.0.1:3000"
        - "http://127.0.0.1:4000"
      allowed-methods: 
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "OPTIONS"
        - "PATCH"
      allowed-headers: "*"
      allow-credentials: true
      max-age: 3600

  # Configuração do DataSource com HikariCP
  datasource:
    url: jdbc:mysql://mysql:3306/financas_db
    driverClassName: com.mysql.cj.jdbc.Driver
    username: appuser
    password: apppassword
    
    # ✅ Configurações específicas do HikariCP
    hikari:
      # Pool de conexões
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      
      # Configurações de transação
      auto-commit: false
      connection-test-query: SELECT 1
      validation-timeout: 5000
      
      # Configurações de performance
      leak-detection-threshold: 60000
      register-mbeans: true
      
      # Configurações específicas do MySQL
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false

  # Configurações JPA com transações
  jpa:
    database-platform: org.hibernate.dialect.MySQLDialect
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    
    # Configurações de transação
    properties:
      hibernate:
        transaction:
          jta:
            platform: enable
        # Configurações de transação
        connection:
          "[provider_disables_autocommit]": true
        jdbc:
          "[batch_size]": 20
          "[batch_versioned_data]": true
        "[order_inserts]": true
        "[order_updates]": true
        # Configurações de cache
        cache:
          "[use_second_level_cache]": false
          "[use_query_cache]": false

  # Configuração do RabbitMQ
  rabbitmq:
    host: rabbitmq
    port: 5672
    username: admin
    password: admin123
    virtual-host: /
    connection-timeout: 15000
    listener:
      simple:
        acknowledge-mode: auto
        retry:
          enabled: true
          max-attempts: 3
          initial-interval: 1000
          max-interval: 10000
          multiplier: 2
        concurrency: 3
        max-concurrency: 10
        prefetch: 1

  # Configuração de transação
  transaction:
    rollback-on-commit-failure: true
    default-timeout: 30

  jackson:
    default-property-inclusion: non_null

# Configuração de Bancos Suportados
bancos:
  suporte:
    names:
      - "banco-do-brasil"
      - "itau"

# Configuração dos Parsers de Extrato
parser:
  # Configuração de auto-discovery
  auto-discovery:
    base-package: "br.com.financas.extrato_api.parser"
    enabled: true
    scan-depth: 2
  config:
    # Banco do Brasil - aceita CSV
    banco-do-brasil:
      name: "Banco do Brasil"
      file-patterns:
        - ".*bb.*\\.csv$"
        - ".*banco.*brasil.*\\.csv$"
        - ".*bb_.*\\.csv$"
        - ".*extrato.*bb.*\\.csv$"
        - "(?i).*extrato.*conta.*corrente.*\\d{6}.*"
      supported-extensions: [".csv"]
      csv:
        separator: ",(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)"
        date-format: "dd/MM/yyyy"
        date-regex: "^\\d{2}/\\d{2}/\\d{4}$"
        value-regex: "^[+-]?\\d{1,3}([.,]\\d{3})*([.,]\\d{1,2})?$|^[+-]?\\d+([.,]\\d{1,2})?$"
        skip-line: 1
        pais: "BR"
        idioma: "pt"
    
    # Itaú - aceita PDF
    itau:
      name: "Itaú"
      file-patterns:
        - ".*itau.*\\.pdf$"
        - ".*itáu.*\\.pdf$"
        - ".*itau_.*\\.pdf$"
        - ".*extrato.*itau.*\\.pdf$"
      supported-extensions: [".pdf"]
      pdf:
        date-format: "dd/MM/yyyy"
        date-regex: "^\\d{2}/\\d{2}/\\d{4}$"
        value-regex: "^[+-]?\\d{1,3}([.,]\\d{3})*([.,]\\d{1,2})?$|^[+-]?\\d+([.,]\\d{1,2})?$"
        # Regex para extrair os 4 campos: data, descrição, data adicional, valor
        # Aceita qualquer nome de lançamento (maiúsculas, hífens, números, pontos, etc.)
        # Exclui transações que contenham "saldo"
        transaction-regex: "(\\d{2}/\\d{2}/\\d{4})\\s+(.+?)\\s+([+-]?\\d{1,3}(?:\\.\\d{3})*(?:,\\d{2})?)(?:\\s+([+-]?\\d{1,3}(?:\\.\\d{3})*(?:,\\d{2})?))?\\s*$"
        header-regex: ".*agência:.*|.*conta:.*|.*saldo em conta.*|.*Limite da Conta.*|.*extrato conta.*|.*período de visualização.*|.*data lançamentos valor.*|.*extrato.*conta.*corrente.*|.*banco.*itau.*|.*itau.*banco.*"
        pais: "BR"
        idioma: "pt"
        text-extraction:
          sort-by-position: true
          encoding: "UTF-8"
  
  # Configuração geral dos parsers
  general:
    parallel-processing: true
    batch-size: 1000
    validation:
      strict-file-type: true
      max-file-size-mb: 50

# Configuração de Observabilidade
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,tracing
  endpoint:
    health:
      show-details: always
    metrics:
      access: read-only
    prometheus:
      access: read-only
  metrics:
    distribution:
      percentiles-histogram:
        "[http.server.requests]": true
      percentiles:
        "[http.server.requests]": 0.5, 0.95, 0.99
      slo:
        "[http.server.requests]": 50ms, 100ms, 200ms, 500ms, 1s, 2s, 5s
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans
  prometheus:
    metrics:
      export:
        enabled: true

# Configuração de logging estruturado
logging:
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"
  level:
    "[br.com.financas.extrato_api]": INFO
    "[org.springframework.web]": DEBUG
    # Logs para debug de transações e HikariCP
    "[com.zaxxer.hikari]": INFO
    "[org.springframework.transaction]": DEBUG
    "[org.springframework.orm.jpa]": DEBUG
    "[org.springframework.jdbc]": DEBUG

# Configuração do Swagger/OpenAPI
springdoc:
  api-docs:
    path: /api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operationsSorter: method
    tagsSorter: alpha
    tryItOutEnabled: true
    filter: true
    displayRequestDuration: true
    displayOperationId: true
    showExtensions: true
    showCommonExtensions: true
  override-with-generic-response: false
  use-hal-as-default-json-media-type: false
