# Configuração da Fatura API - Ambiente de Homologação
# Este arquivo é servido pelo Config Server

spring:
  application:
    name: fatura-api
  
  # Configuração do DataSource com HikariCP
  datasource:
    url: jdbc:mysql://mysql:3306/financas_db
    driverClassName: com.mysql.cj.jdbc.Driver
    username: appuser
    password: apppassword
    
    # ✅ Configurações específicas do HikariCP
    hikari:
      # Pool de conexões
      maximum-pool-size: 30
      minimum-idle: 10
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      
      # Configurações de transação
      auto-commit: false
      connection-test-query: SELECT 1
      validation-timeout: 5000
      
      # Configurações de performance
      leak-detection-threshold: 60000
      register-mbeans: true
      
      # Configurações específicas do MySQL
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    database-platform: org.hibernate.dialect.MySQLDialect
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        jdbc:
          batch_size: 30
        order_inserts: true
        order_updates: true
  
  # Configuração do RabbitMQ
  rabbitmq:
    host: ${RABBITMQ_HOST:rabbitmq}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:admin}
    password: ${RABBITMQ_PASSWORD:admin123}
    virtual-host: ${RABBITMQ_VHOST:/}
    connection-timeout: 60000
    listener:
      simple:
        retry:
          enabled: true
          max-attempts: 3
          initial-interval: 1000
          max-interval: 10000
          multiplier: 2

# Configuração do Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,env,configprops,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true

# Configuração de logging
logging:
  level:
    "[br.com.financas.fatura_api]": INFO
    "[org.springframework.amqp]": WARN
    "[org.springframework.orm.jpa]": WARN

# Configuração de Bancos Suportados
bancos:
  suporte:
    names:
      - "banco-do-brasil"
      - "itau"

# Configuração dos Parsers de Fatura
parser:
  auto-discovery:
    base-package: "br.com.financas.fatura_api.parser"
    enabled: true
    scan-depth: 2
  config:
    banco-do-brasil:
      name: "Banco do Brasil"
      file-patterns:
        - ".*bb.*\\.pdf$"
        - ".*banco.*brasil.*\\.pdf$"
      supported-extensions: [".pdf"]
      pdf:
        date-format: "dd/MM/yyyy"
        date-regex: "^\\d{2}/\\d{2}/\\d{4}$"
        value-regex: "^[+-]?\\d{1,3}([.,]\\d{3})*([.,]\\d{1,2})?$|^[+-]?\\d+([.,]\\d{1,2})?$"
        transaction-regex: "(\\d{2}/\\d{2}/\\d{4})\\s+(.+?)\\s+([+-]?\\d{1,3}(?:\\.\\d{3})*(?:,\\d{2})?)(?:\\s+([+-]?\\d{1,3}(?:\\.\\d{3})*(?:,\\d{2})?))?\\s*$"
        header-regex: ".*agência:.*|.*conta:.*|.*saldo em conta.*"
        pais: "BR"
        idioma: "pt"
        text-extraction:
          sort-by-position: true
          encoding: "UTF-8"
        csv:
          delimiter: ";"
          encoding: "UTF-8"
          date-format: "dd/MM/yyyy"
          value-format: "#,##0.00"
          header-row: 0
          data-start-row: 1
          date-regex: "^\\d{2}/\\d{2}/\\d{4}$"
          value-regex: "^[+-]?\\d{1,3}([.,]\\d{3})*([.,]\\d{1,2})?$"
          idioma: "pt"
          pais: "BR"
    itau:
      name: "Itaú"
      file-patterns:
        - ".*itau.*\\.pdf$"
        - ".*\\.pdf$"
      supported-extensions: [".pdf"]
      pdf:
        date-format: "dd/MM/yyyy"
        date-regex: "^\\d{2}/\\d{2}/\\d{4}$"
        value-regex: "^[+-]?\\d{1,3}([.,]\\d{3})*([.,]\\d{1,2})?$|^[+-]?\\d+([.,]\\d{1,2})?$"
        transaction-regex: "(\\d{2}/\\d{2}/\\d{4})\\s+(.+?)\\s+([+-]?\\d{1,3}(?:\\.\\d{3})*(?:,\\d{2})?)(?:\\s+([+-]?\\d{1,3}(?:\\.\\d{3})*(?:,\\d{2})?))?\\s*$"
        header-regex: ".*agência:.*|.*conta:.*|.*saldo em conta.*"
        pais: "BR"
        idioma: "pt"
        text-extraction:
          sort-by-position: true
          encoding: "UTF-8"
        csv:
          delimiter: ";"
          encoding: "UTF-8"
          date-format: "dd/MM/yyyy"
          value-format: "#,##0.00"
          header-row: 0
          data-start-row: 1
          date-regex: "^\\d{2}/\\d{2}/\\d{4}$"
          value-regex: "^[+-]?\\d{1,3}([.,]\\d{3})*([.,]\\d{1,2})?$"
          idioma: "pt"
          pais: "BR"
  general:
    parallel-processing: true
    batch-size: 1000
    validation:
      strict-file-type: true
      max-file-size-mb: 50

# Configuração de observabilidade
observability:
  metrics:
    enabled: true
  tracing:
    enabled: true
  zipkin:
    base-url: ${ZIPKIN_BASE_URL:http://zipkin:9411}
